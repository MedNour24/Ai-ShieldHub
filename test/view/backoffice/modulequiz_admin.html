<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Questions</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />

  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
  <link rel="stylesheet" href="../../assets/css/kaiadmin.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

  <style>
    body {
      background: #f9f9f9 !important;
      padding: 20px;
    }

    /* --- WHITE & PURPLE MODAL THEME --- */
    .modal-content {
      border: none;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      background: #fff;
    }

    .modal-header {
      background: #6861ce !important;
      color: #fff;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      border-bottom: none;
      padding: 20px 30px;
    }

    .modal-title {
      font-weight: 700;
      font-size: 18px;
      color: white !important;
    }

    .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
      opacity: 1;
    }

    .modal-body {
      padding: 30px;
    }

    .form-group-default {
      background: #fff !important;
      border: 1px solid #ebedf2 !important;
      border-radius: 5px;
      margin-bottom: 15px;
      padding: 5px 10px;
    }

    .form-group-default label {
      color: #6861ce !important;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .form-control,
    .form-select {
      border: none !important;
      padding: 5px 0 !important;
      height: auto !important;
      font-size: 14px;
      color: #495057 !important;
      background: transparent !important;
    }

    .form-control:focus,
    .form-select:focus {
      box-shadow: none !important;
      background: transparent !important;
    }

    .btn-save {
      background: #6861ce;
      border: none;
      width: 100%;
      padding: 12px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 16px;
      margin-top: 10px;
      color: white;
      transition: 0.3s;
    }

    .btn-save:hover {
      background: #5a52b5;
      color: white;
    }

    .alert-custom {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: none;
    }

    /* NEW: Choice Buttons Styling */
    .choice-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .btn-choice {
      flex: 1;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .btn-choice:hover {
      border-color: #6861ce;
      background: #f8f7ff;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(104, 97, 206, 0.2);
    }

    .btn-choice i {
      font-size: 32px;
      color: #6861ce;
      margin-bottom: 10px;
      display: block;
    }

    .btn-choice h5 {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }

    .btn-choice p {
      font-size: 12px;
      color: #999;
      margin: 0;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .back-link {
      color: #6861ce;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 15px;
      display: inline-block;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    /* Copy Quiz Selection Styling */
    .quiz-copy-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ebedf2;
      border-radius: 8px;
      padding: 10px;
    }

    .quiz-copy-item {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quiz-copy-item:hover {
      border-color: #6861ce;
      background: #f8f7ff;
    }

    .quiz-copy-item.selected {
      border-color: #6861ce;
      background: #6861ce;
      color: white;
    }

    .quiz-copy-item .quiz-info h6 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .quiz-copy-item .quiz-info p {
      margin: 0;
      font-size: 12px;
      color: #999;
    }

    .quiz-copy-item.selected .quiz-info p {
      color: rgba(255, 255, 255, 0.8);
    }

    .questions-preview {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
    }

    .questions-preview h6 {
      font-size: 13px;
      font-weight: 700;
      color: #6861ce;
      margin-bottom: 10px;
    }

    .questions-preview .question-item {
      padding: 8px;
      background: white;
      border-radius: 5px;
      margin-bottom: 8px;
      font-size: 12px;
      border-left: 3px solid #6861ce;
    }

    .form-check-input:checked {
      background-color: #6861ce;
      border-color: #6861ce;
    }

    .form-check-input {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div id="alertBox" class="alert alert-success alert-custom" role="alert"></div>

    <div class="row">
      <div class="col-md-12">
        <div class="card card-round">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <h4 class="card-title">Question </h4>
              <button class="btn btn-primary btn-round ms-auto" onclick="openAddModal()">
                <i class="fa fa-plus"></i> Add Question
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="add-row" class="display table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Parent Quiz</th>
                    <th>Question</th>
                    <th>Options</th>
                    <th style="width: 15%">Actions</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr>
                    <td colspan="5" class="text-center">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- WHITE/PURPLE MODAL -->
  <div class="modal fade" id="questionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add New Question</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="question_id">

          <!-- STEP 1: Select Quiz -->
          <div id="step1-select-quiz" class="form-section active">
            <div class="form-group-default">
              <label>Link to Quiz</label>
              <select class="form-control" id="id_quiz_select">
                <option value="">Loading quizzes...</option>
              </select>
            </div>

            <div class="choice-buttons">
              <div class="btn-choice" onclick="showNewQuestionForm()">
                <i class="fas fa-plus-circle"></i>
                <h5>Create New Question</h5>
                <p>Write a custom question</p>
              </div>
              <div class="btn-choice" onclick="showCopyQuestionsForm()">
                <i class="fas fa-copy"></i>
                <h5>Copy from Quiz</h5>
                <p>Reuse existing questions</p>
              </div>
            </div>
          </div>

          <!-- STEP 2A: New Question Form -->
          <div id="step2a-new-question" class="form-section">
            <a class="back-link" onclick="backToStep1()"><i class="fas fa-arrow-left"></i> Back</a>

            <div class="form-group-default">
              <label>Question Text</label>
              <input id="question_titre" type="text" class="form-control" placeholder="Ex: What is phishing?">
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="form-group-default">
                  <label>Option 1</label>
                  <input id="option1" type="text" class="form-control" placeholder="A">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group-default">
                  <label>Option 2</label>
                  <input id="option2" type="text" class="form-control" placeholder="B">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group-default">
                  <label>Option 3</label>
                  <input id="option3" type="text" class="form-control" placeholder="C">
                </div>
              </div>
            </div>

            <div class="form-group-default">
              <label>Correct Answer</label>
              <select class="form-control" id="correct_option">
                <option value="1">Option 1</option>
                <option value="2">Option 2</option>
                <option value="3">Option 3</option>
              </select>
            </div>

            <button type="button" class="btn btn-save" onclick="saveQuestion()">Save Question</button>
          </div>

          <!-- STEP 2B: Copy Questions Form -->
          <div id="step2b-copy-questions" class="form-section">
            <a class="back-link" onclick="backToStep1()"><i class="fas fa-arrow-left"></i> Back</a>

            <div class="form-group-default">
              <label>Select Source Quiz</label>
              <div class="quiz-copy-list" id="quizCopyList">
                <p class="text-center text-muted">Loading quizzes...</p>
              </div>
            </div>

            <div id="questionsPreview" class="questions-preview" style="display: none;">
              <h6><i class="fas fa-list"></i> Questions to Copy</h6>
              <div id="questionsPreviewList"></div>
            </div>

            <button type="button" class="btn btn-save" onclick="copyQuestions()" id="btnCopyQuestions" style="display: none;">
              Copy Selected Questions
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SHOW DETAILS MODAL -->
  <div class="modal fade" id="showModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Question Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center" id="showContent"></div>
        <div class="modal-footer border-0" style="padding: 0 30px 30px;">
          <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal"
            style="border-radius: 30px;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>

  <script>
    const API_BASE = "../../Controller/api_admin.php";
    let allQuizzes = [];
    let selectedSourceQuizId = null;
    let questionsToPreview = [];

    $(document).ready(function () {
      loadQuestions();
      loadQuizzesForDropdown();
    });

    function loadQuizzesForDropdown() {
      return new Promise((resolve, reject) => {
        $.getJSON(`${API_BASE}?action=getQuizzes`, function (data) {
          allQuizzes = data;
          let opts = '<option value="">-- Select a Quiz --</option>';
          data.forEach(q => {
            opts += `<option value="${q.id_quiz}">${escapeHtml(q.titre)}</option>`;
          });
          $("#id_quiz_select").html(opts);
          resolve();
        }).fail(reject);
      });
    }

    function loadQuestions() {
      $.getJSON(`${API_BASE}?action=getQuestions`, function (data) {
        let rows = "";
        if (data.length === 0) {
          rows = `<tr><td colspan="5" class="text-center text-muted">No questions found</td></tr>`;
        } else {
          data.forEach(q => {
            rows += `
              <tr>
                <td>${q.id_reponse}</td>
                <td class="text-primary fw-bold">${escapeHtml(q.quiz_titre || 'Unknown Quiz')}</td>
                <td>${escapeHtml(q.question)}</td>
                <td>
                  <small class="d-block text-muted">1. ${escapeHtml(q.option1)}</small>
                  <small class="d-block text-muted">2. ${escapeHtml(q.option2)}</small>
                </td>
                <td>
                  <div class="form-button-action">
                    <button class="btn btn-link btn-info btn-lg" onclick="showDetails('${escapeHtml(q.question)}', '${escapeHtml(q.quiz_titre)}', '${escapeHtml(q.option1)}', '${escapeHtml(q.option2)}', '${escapeHtml(q.option3)}', ${q.reponse_correcte})"><i class="fa fa-eye"></i></button>
                    <button class="btn btn-link btn-primary btn-lg" onclick="editQuestion(${q.id_reponse})"><i class="fa fa-edit"></i></button>
                    <button class="btn btn-link btn-danger" onclick="deleteQuestion(${q.id_reponse})"><i class="fa fa-times"></i></button>
                  </div>
                </td>
              </tr>`;
          });
        }
        $("#tableBody").html(rows);
      });
    }

    function openAddModal() {
      resetForm();
      showStep1();
      $("#questionModal").modal('show');
    }

    function showStep1() {
      $(".form-section").removeClass("active");
      $("#step1-select-quiz").addClass("active");
    }

    function showNewQuestionForm() {
      const quizId = $("#id_quiz_select").val();
      if (!quizId) {
        alert("Please select a quiz first!");
        return;
      }
      $(".form-section").removeClass("active");
      $("#step2a-new-question").addClass("active");
    }

    function showCopyQuestionsForm() {
      const targetQuizId = $("#id_quiz_select").val();
      if (!targetQuizId) {
        alert("Please select a target quiz first!");
        return;
      }

      $(".form-section").removeClass("active");
      $("#step2b-copy-questions").addClass("active");

      let html = '';
      allQuizzes.forEach(quiz => {
        if (quiz.id_quiz != targetQuizId) {
          html += `
            <div class="quiz-copy-item" onclick="selectSourceQuiz(${quiz.id_quiz})">
              <div class="quiz-info">
                <h6>${escapeHtml(quiz.titre)}</h6>
                <p>${escapeHtml(quiz.description || 'No description')}</p>
              </div>
              <i class="fas fa-chevron-right"></i>
            </div>
          `;
        }
      });
      $("#quizCopyList").html(html || '<p class="text-center text-muted">No other quizzes available</p>');
    }

    function selectSourceQuiz(quizId) {
      selectedSourceQuizId = quizId;
      
      $(".quiz-copy-item").removeClass("selected");
      event.currentTarget.classList.add("selected");

      $.getJSON(`${API_BASE}?action=getQuestions`, function (allQuestions) {
        questionsToPreview = allQuestions.filter(q => q.id_quiz == quizId);
        
        if (questionsToPreview.length === 0) {
          $("#questionsPreview").hide();
          $("#btnCopyQuestions").hide();
          alert("This quiz has no questions to copy.");
          return;
        }

        let previewHtml = `
          <div style="margin-bottom: 10px; text-align: right;">
            <button class="btn btn-sm btn-outline-primary" onclick="selectAllQuestions(true)" style="font-size: 11px; padding: 4px 10px; border-radius: 15px;">
              <i class="fas fa-check-double"></i> Select All
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="selectAllQuestions(false)" style="font-size: 11px; padding: 4px 10px; border-radius: 15px; margin-left: 5px;">
              <i class="fas fa-times"></i> Deselect All
            </button>
          </div>
        `;
        
        questionsToPreview.forEach((q, idx) => {
          previewHtml += `
            <div class="question-item" style="display: flex; align-items: start; gap: 10px; cursor: pointer;" onclick="toggleQuestionCheckbox(${q.id_reponse})">
              <input type="checkbox" 
                     class="form-check-input question-checkbox" 
                     id="q_${q.id_reponse}" 
                     data-question-id="${q.id_reponse}"
                     checked
                     onclick="event.stopPropagation()"
                     style="cursor: pointer; margin-top: 2px;">
              <label for="q_${q.id_reponse}" style="cursor: pointer; flex: 1;">
                <strong>${idx + 1}.</strong> ${escapeHtml(q.question)}
              </label>
            </div>
          `;
        });

        $("#questionsPreviewList").html(previewHtml);
        $("#questionsPreview").show();
        $("#btnCopyQuestions").show();
      });
    }

    function toggleQuestionCheckbox(questionId) {
      const checkbox = $(`#q_${questionId}`);
      checkbox.prop('checked', !checkbox.prop('checked'));
    }

    function selectAllQuestions(selectAll) {
      $(".question-checkbox").prop('checked', selectAll);
    }

    function copyQuestions() {
      const targetQuizId = $("#id_quiz_select").val();
      
      const selectedQuestions = [];
      $(".question-checkbox:checked").each(function() {
        const questionId = $(this).data('question-id');
        const question = questionsToPreview.find(q => q.id_reponse == questionId);
        if (question) {
          selectedQuestions.push(question);
        }
      });

      if (selectedQuestions.length === 0) {
        alert("Please select at least one question to copy.");
        return;
      }

      if (!confirm(`Copy ${selectedQuestions.length} selected question(s) to the target quiz?`)) {
        return;
      }

      let successCount = 0;
      let promises = [];

      selectedQuestions.forEach(q => {
        const fd = new FormData();
        fd.append('action', 'addQuestion');
        fd.append('id_quiz', targetQuizId);
        fd.append('titre', q.question);
        fd.append('option1', q.option1);
        fd.append('option2', q.option2);
        fd.append('option3', q.option3);
        fd.append('correct_option', q.reponse_correcte);

        promises.push(
          $.ajax({
            url: API_BASE,
            type: 'POST',
            data: fd,
            processData: false,
            contentType: false
          })
        );
      });

      Promise.all(promises).then(results => {
        results.forEach(res => {
          if (res.success) successCount++;
        });

        $("#questionModal").modal('hide');
        showAlert(`${successCount} question(s) copied successfully!`, "success");
        loadQuestions();
      });
    }

    function backToStep1() {
      showStep1();
      selectedSourceQuizId = null;
      $("#questionsPreview").hide();
      $("#btnCopyQuestions").hide();
    }

    function saveQuestion() {
      const qText = $("#question_titre").val().trim();
      const o1 = $("#option1").val().trim();
      const quizId = $("#id_quiz_select").val();

      if (!quizId) { alert("Please select a parent quiz."); return; }
      if (!qText) { alert("Question text is required."); return; }
      if (!o1) { alert("At least Option 1 is required."); return; }

      const id = $("#question_id").val();
      const fd = new FormData();
      fd.append('action', id ? 'updateQuestion' : 'addQuestion');
      if (id) fd.append('id', id);
      fd.append('id_quiz', quizId);
      fd.append('titre', qText);
      fd.append('option1', o1);
      fd.append('option2', $("#option2").val());
      fd.append('option3', $("#option3").val());
      fd.append('correct_option', $("#correct_option").val());

      $.ajax({
        url: API_BASE, type: 'POST', data: fd, processData: false, contentType: false,
        success: function (res) {
          if (res.success) {
            $("#questionModal").modal('hide');
            showAlert("Success!", "success");
            loadQuestions();
          } else { showAlert("Error saving data", "danger"); }
        }
      });
    }

    async function editQuestion(id) {
      await loadQuizzesForDropdown();
      $.getJSON(`${API_BASE}?action=getQuestion&id=${id}`, function (data) {
        $("#question_id").val(data.id_reponse);
        $("#id_quiz_select").val(data.id_quiz);
        $("#question_titre").val(data.question);
        $("#option1").val(data.option1);
        $("#option2").val(data.option2);
        $("#option3").val(data.option3);
        $("#correct_option").val(data.reponse_correcte);

        $(".form-section").removeClass("active");
        $("#step2a-new-question").addClass("active");
        $("#modalTitle").text("Edit Question");
        $("#questionModal").modal('show');
      });
    }

    function showDetails(text, quiz, o1, o2, o3, correct) {
      $("#showContent").html(`
        <h5 class="text-primary mb-3">Quiz: ${quiz || 'N/A'}</h5>
        <p class="fw-bold" style="font-size:1.2em; color:#333;">${text}</p>
        <ul class="list-group list-group-flush text-start">
          <li class="list-group-item ${correct == 1 ? 'list-group-item-success' : ''}">1. ${o1}</li>
          <li class="list-group-item ${correct == 2 ? 'list-group-item-success' : ''}">2. ${o2}</li>
          <li class="list-group-item ${correct == 3 ? 'list-group-item-success' : ''}">3. ${o3}</li>
        </ul>
      `);
      $("#showModal").modal('show');
    }

    function deleteQuestion(id) {
      if (confirm("Delete?")) {
        $.ajax({
          url: API_BASE, type: 'POST', data: { action: 'deleteQuestion', id: id }, success: function (res) {
            if (res.success) { loadQuestions(); showAlert("Deleted", "danger"); }
          }
        });
      }
    }

    function resetForm() {
      $("#question_id").val("");
      $("#question_titre").val("");
      $("#option1").val("");
      $("#option2").val("");
      $("#option3").val("");
      $("#correct_option").val("1");
      $("#modalTitle").text("Add New Question");
      selectedSourceQuizId = null;
      questionsToPreview = [];
    }

    function showAlert(msg, type) {
      $("#alertBox").removeClass('alert-success alert-danger').addClass('alert-' + type).text(msg).fadeIn().delay(3000).fadeOut();
    }

    function escapeHtml(text) {
      return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/'/g, "&#039;").replace(/"/g, "&quot;") : '';
    }
  </script>
</body>

</html>